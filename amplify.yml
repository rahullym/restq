version: 1
frontend:
  phases:
    preBuild:
      commands:
        # Install dependencies with optional deps so platform binaries can be installed
        - echo "Installing dependencies (including optional platform binaries)..."
        - npm install --no-audit --no-fund --include=optional

        # Ensure lightningcss platform binaries are present and linked correctly
        - echo "Ensuring lightningcss platform binaries are installed..."
        - npm rebuild lightningcss || npm install --force lightningcss@1.30.2
        - echo "Verifying lightningcss Linux binary..."
        - |
          if [ ! -f "node_modules/lightningcss-linux-x64-gnu/lightningcss.linux-x64-gnu.node" ]; then
            echo "lightningcss Linux binary not found, attempting manual install..."
            npm install --save-optional lightningcss-linux-x64-gnu@1.30.2 || echo "Optional lightningcss-linux-x64-gnu install attempted"
            npm rebuild lightningcss || echo "lightningcss rebuild attempted"
          else
            echo "lightningcss Linux binary found"
          fi

        # Ensure tailwindcss oxide platform binaries are present
        - echo "Ensuring tailwindcss oxide platform binaries are installed..."
        - npm rebuild @tailwindcss/oxide || npm install --force @tailwindcss/oxide@4.1.18
        - echo "Verifying tailwindcss oxide Linux binary..."
        - |
          if [ ! -f "node_modules/@tailwindcss/oxide-linux-x64-gnu/tailwindcss-oxide.linux-x64-gnu.node" ]; then
            echo "tailwindcss oxide Linux binary not found, attempting manual install..."
            npm install --save-optional @tailwindcss/oxide-linux-x64-gnu@4.1.18 || echo "Optional @tailwindcss/oxide-linux-x64-gnu install attempted"
            npm rebuild @tailwindcss/oxide || echo "tailwindcss oxide rebuild attempted"
          else
            echo "tailwindcss oxide Linux binary found"
          fi

        # Generate Prisma Client (does not require DATABASE_URL, only schema)
        - echo "Generating Prisma Client..."
        - npx prisma generate --schema=./prisma/schema.prisma
    build:
      commands:
        # Run database migrations only if migrations directory exists and has files
        - echo "Checking for database migrations..."
        - |
          if [ -d "prisma/migrations" ] && [ "$(ls -A prisma/migrations 2>/dev/null)" ]; then
            echo "Migrations found, deploying..."
            if [ -n "$DATABASE_URL" ]; then
              npx prisma migrate deploy || echo "Migration deployment failed, continuing build..."
            else
              echo "DATABASE_URL not set, skipping migrations (will run at runtime)"
            fi
          else
            echo "No migrations found, skipping migrate deploy"
          fi
        # Build Next.js application
        - echo "Building Next.js application..."
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
